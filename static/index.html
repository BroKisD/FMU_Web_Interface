<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FMU Web Runner</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif; 
      margin: 0; 
      background: #f5f7fa; 
      color: #2d3748; 
      line-height: 1.6;
    }
    header { 
      background: linear-gradient(135deg, #000000 0%, #000000 100%); 
      color: #fff; 
      padding: 20px 24px; 
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    h1 { margin: 0; font-size: 24px; font-weight: 600; }
    .container { max-width: 1400px; margin: 0 auto; padding: 0 16px; }
    .card { 
      background: #fff; 
      margin: 20px 0; 
      padding: 24px; 
      border-radius: 12px; 
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      border: 1px solid #e2e8f0;
    }
    .card h2 { 
      margin: 0 0 20px 0; 
      font-size: 18px; 
      font-weight: 600; 
      color: #1a202c;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card h2::before {
      content: '';
      display: inline-block;
      width: 4px;
      height: 20px;
      background: linear-gradient(135deg, #000000 0%, #000000 100%);
      border-radius: 2px;
    }
    
    .upload-area {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    input[type="file"] {
      padding: 10px 16px;
      border: 2px dashed #cbd5e0;
      border-radius: 8px;
      background: #f7fafc;
      cursor: pointer;
      flex: 1;
      min-width: 250px;
    }
    input[type="file"]:hover {
      border-color: #667eea;
      background: #edf2f7;
    }
    
    button { 
      background: linear-gradient(135deg, #000000 0%, #000000 100%);
      border: none; 
      color: #fff; 
      padding: 10px 24px; 
      border-radius: 8px; 
      cursor: pointer; 
      font-weight: 500;
      font-size: 14px;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
    }
    button:hover { 
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(102, 126, 234, 0.4);
    }
    button:active {
      transform: translateY(0);
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .form-group label {
      font-size: 13px;
      font-weight: 500;
      color: #4a5568;
    }
    
    .form-group input,
    .form-group select {
      padding: 10px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 14px;
      background: #fff;
      transition: all 0.2s;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #000000;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .form-group textarea {
      padding: 10px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 13px;
      font-family: ui-monospace, Menlo, Consolas, monospace;
      background: #f7fafc;
      min-height: 100px;
      resize: vertical;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: #f7fafc;
      border-radius: 6px;
      border: 1px solid #e2e8f0;
    }
    
    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .checkbox-group label {
      margin: 0;
      cursor: pointer;
      user-select: none;
    }
    
    .section-title {
      font-size: 15px;
      font-weight: 600;
      color: #2d3748;
      margin: 20px 0 12px 0;
      padding-bottom: 8px;
      border-bottom: 2px solid #e2e8f0;
    }
    
    .actions {
      display: flex;
      gap: 12px;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    .btn-secondary {
      background: #718096;
      box-shadow: 0 2px 4px rgba(113, 128, 150, 0.3);
    }
    
    .btn-secondary:hover {
      box-shadow: 0 4px 8px rgba(113, 128, 150, 0.4);
    }
    
    pre { 
      background: #f7fafc; 
      padding: 16px; 
      border-radius: 8px; 
      overflow: auto; 
      font-size: 13px;
      border: 1px solid #e2e8f0;
      margin: 0;
    }
    
    details {
      margin-top: 16px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 12px;
      background: #f7fafc;
    }
    
    details summary {
      cursor: pointer;
      font-weight: 500;
      color: #4a5568;
      user-select: none;
      padding: 4px;
    }
    
    details[open] summary {
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .chart-container {
      width: 100%;
      margin-bottom: 24px;
      padding: 16px;
      background: #fff;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    
    .chart-container:last-child {
      margin-bottom: 0;
    }
    
    .chart {
      width: 100%;
      height: 400px;
    }
    
    #downloads {
      margin-top: 16px;
      padding: 12px;
      background: #f7fafc;
      border-radius: 8px;
      border: 1px solid #e2e8f0;
    }
    
    #downloads a {
      color: #667eea;
      text-decoration: none;
      font-weight: 500;
      margin-right: 16px;
    }
    
    #downloads a:hover {
      text-decoration: underline;
    }
    
    .status-message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-top: 12px;
      font-size: 14px;
    }
    
    .status-success {
      background: #c6f6d5;
      color: #22543d;
      border: 1px solid #9ae6b4;
    }
    
    .status-error {
      background: #fed7d7;
      color: #742a2a;
      border: 1px solid #fc8181;
    }
    
    .array-input {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .array-item {
      padding: 8px;
      background: #edf2f7;
      border-radius: 4px;
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-size: 12px;
    }
  </style>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
</head>
<body>
  <header>
    <div class="container">
      <h1>FMU Runner</h1>
    </div>
  </header>

  <div class="container">
    <div class="card">
      <h2>Upload FMU</h2>
      <div class="upload-area">
        <input id="fmuFile" type="file" accept=".fmu"/>
        <button id="btnUpload">Upload FMU</button>
      </div>
      <div id="uploadStatus"></div>
    </div>

    <div class="card">
      <h2>Configuration</h2>
      
      <div class="form-grid">
        <div class="form-group">
          <label>Start Time</label>
          <input type="number" id="start_time" step="any" value="0.0">
        </div>
        
        <div class="form-group">
          <label>Stop Time</label>
          <input type="number" id="stop_time" step="any" value="600.0">
        </div>
        
        <div class="form-group">
          <label>Step Size</label>
          <input type="number" id="step_size" step="any" value="0.01">
        </div>
        
        <div class="form-group">
          <label>Solver</label>
          <select id="solver">
            <option value="CVode">CVode</option>
            <option value="Euler">Euler</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Relative Tolerance</label>
          <input type="number" id="relative_tolerance" step="any" value="0.00001">
        </div>
        
        <div class="form-group">
          <label>Timeout (seconds)</label>
          <input type="number" id="timeout" value="60">
        </div>
      </div>

      <div class="section-title">Options</div>
      <div class="form-grid">
        <div class="checkbox-group">
          <input type="checkbox" id="record_events" checked>
          <label for="record_events">Record Events</label>
        </div>
        
        <div class="checkbox-group">
          <input type="checkbox" id="debug_logging">
          <label for="debug_logging">Debug Logging</label>
        </div>  
      </div>

    <div class="section-title">Start Values (JSON)</div>
      <div class="form-group">
        <textarea id="start_values" placeholder='{"param1": 1.0, "param2": 2.0}'>{}</textarea>
      </div>

      <div class="section-title">Inputs (JSON)</div>
      <div class="form-group">
        <textarea id="inputs" placeholder='[["q", [[0.0, 0.0]]]]'>[]</textarea>
      </div>

      <div class="section-title">Outputs (comma-separated)</div>
      <div class="form-group">
        <input type="text" id="outputs" placeholder="x, v, p" value="x, v, p">
      </div>

      <div class="form-grid" style="margin-top: 20px;">
        <div class="form-group">
          <label>Output CSV File</label>
          <input type="text" id="output_csv" value="result.csv">
        </div>
      </div>

      <div class="actions">
        <button id="btnRun">▶ Run Simulation</button>
        <button class="btn-secondary" id="btnViewJson">View JSON</button>
      </div>

      <details>
        <summary>FMU Variables (from metadata)</summary>
        <pre id="varsDump">Upload an FMU to see variables</pre>
      </details>
      
      <details>
        <summary>FMU Info</summary>
        <pre id="fmuInfo">Upload an FMU to see info</pre>
      </details>
    </div>

    <div class="card">
      <h2>Results</h2>
      <div id="chartsContainer"></div>
      <div id="downloads"></div>
      <details>
        <summary>Simulation Logs</summary>
        <pre id="logs">No logs yet</pre>
      </details>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    // Helper to gather config from form
    function getConfig() {
      const outputs = $('outputs').value.split(',').map(s => s.trim()).filter(Boolean);
      
      let startValues = {};
      try {
        const sv = $('start_values').value.trim();
        if (sv) startValues = JSON.parse(sv);
      } catch (e) {
        alert('Start Values is not valid JSON: ' + e.message);
        throw e;
      }
      
      let inputs = [];
      try {
        const inp = $('inputs').value.trim();
        if (inp) inputs = JSON.parse(inp);
      } catch (e) {
        alert('Inputs is not valid JSON: ' + e.message);
        throw e;
      }
      
      return {
        fmu: null, // will be set by backend
        start_time: parseFloat($('start_time').value),
        stop_time: parseFloat($('stop_time').value),
        step_size: parseFloat($('step_size').value),
        solver: $('solver').value,
        relative_tolerance: parseFloat($('relative_tolerance').value),
        record_events: $('record_events').checked,
        fmi_type: null,
        start_values: startValues,
        inputs: inputs,
        outputs: outputs,
        timeout: parseInt($('timeout').value),
        debug_logging: $('debug_logging').checked,
        output_csv: $('output_csv').value,
      };
    }

    // Helper to populate form from config
    function setConfig(cfg) {
      $('start_time').value = cfg.start_time || 0;
      $('stop_time').value = cfg.stop_time || 600;
      $('step_size').value = cfg.step_size || 0.01;
      $('solver').value = cfg.solver || 'CVode';
      $('relative_tolerance').value = cfg.relative_tolerance || 0.00001;
      $('timeout').value = cfg.timeout || 60;
      $('record_events').checked = cfg.record_events !== false;
      $('debug_logging').checked = cfg.debug_logging || false;
      $('start_values').value = JSON.stringify(cfg.start_values || {}, null, 2);
      $('inputs').value = JSON.stringify(cfg.inputs || [], null, 2);
      $('outputs').value = (cfg.outputs || []).join(', ');
      $('output_csv').value = cfg.output_csv || 'result.csv';
    }

    $('btnUpload').onclick = async () => {
      const file = $('fmuFile').files[0];
      if (!file) {
        $('uploadStatus').innerHTML = '<div class="status-message status-error">Please select a .fmu file first.</div>';
        return;
      }
      
      const fd = new FormData();
      fd.append('file', file);
      $('uploadStatus').innerHTML = '<div class="status-message">Uploading...</div>';
      
      try {
        const res = await fetch('/api/upload-fmu', { method: 'POST', body: fd });
        const js = await res.json();
        
        if (!js.ok) {
          $('uploadStatus').innerHTML = '<div class="status-message status-error">Upload failed: ' + (js.error || 'unknown') + '</div>';
          return;
        }
        
        $('uploadStatus').innerHTML = '<div class="status-message status-success">✓ Uploaded successfully<br>Host platform: ' + js.template.platform + '</div>';
        
        // Populate form with template config
        if (js.template.config) {
          setConfig(js.template.config);
        }
        
        $('varsDump').textContent = JSON.stringify(js.template.variables, null, 2);
        $('fmuInfo').textContent = js.template.info;
      } catch (e) {
        $('uploadStatus').innerHTML = '<div class="status-message status-error">Error: ' + e.message + '</div>';
      }
    };

    $('btnViewJson').onclick = () => {
      try {
        const cfg = getConfig();
        alert(JSON.stringify(cfg, null, 2));
      } catch (e) {
        // Error already shown by getConfig
      }
    };

    $('btnRun').onclick = async () => {
      let cfg;
      try {
        cfg = getConfig();
      } catch (e) {
        return; // Error already shown
      }

      $('logs').textContent = 'Running simulation...';
      $('downloads').innerHTML = '';
      $('chartsContainer').innerHTML = '';

      try {
        const res = await fetch('/api/run', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(cfg)
        });
        const js = await res.json();

        if (!js.ok) {
          $('logs').textContent = (js.logs || []).join('\n') + '\n\n ERROR: ' + js.error + '\n' + (js.trace || '');
          alert('Simulation failed. Check logs below.');
          return;
        }

        // Show logs
        $('logs').textContent = (js.logs || []).join('\n') + '\n\n Simulation completed successfully';

        // Plot results - separate graph for each output
        const cols = js.columns || [];
        const rows = js.rows || [];
        const time = rows.map(r => r.time !== undefined ? r.time : r[cols[0]]);
        const outputs = cols.filter(c => c !== 'time');

        if (outputs.length > 0) {
          const chartsContainer = $('chartsContainer');
          
          // Color palette for different graphs
          const colors = [
            '#667eea', // Purple
            '#f56565', // Red
            '#48bb78', // Green
            '#ed8936', // Orange
            '#4299e1', // Blue
            '#9f7aea', // Violet
            '#ed64a6', // Pink
            '#38b2ac', // Teal
            '#ecc94b', // Yellow
            '#f687b3'  // Rose
          ];
          
          // Create a separate graph for each output
          outputs.forEach((outputName, idx) => {
            // Create container div for this chart
            const chartWrapper = document.createElement('div');
            chartWrapper.className = 'chart-container';
            
            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart';
            chartDiv.id = `chart_${idx}`;
            
            chartWrapper.appendChild(chartDiv);
            chartsContainer.appendChild(chartWrapper);
            
            // Create trace for this output with unique color
            const trace = {
              x: time,
              y: rows.map(r => r[outputName]),
              mode: 'lines',
              name: outputName,
              line: { width: 2, color: colors[idx % colors.length] }
            };
            
            // Create layout for this chart
            const layout = {
              title: { 
                text: outputName, 
                font: { size: 16, weight: 600 } 
              },
              xaxis: { 
                title: 'Time [s]', 
                gridcolor: '#e2e8f0' 
              },
              yaxis: { 
                title: outputName, 
                gridcolor: '#e2e8f0' 
              },
              paper_bgcolor: '#ffffff',
              plot_bgcolor: '#f7fafc',
              margin: { t: 50, b: 60, l: 60, r: 40 }
            };
            
            // Plot this chart
            Plotly.newPlot(`chart_${idx}`, [trace], layout, {responsive: true});
          });
        } else {
          $('logs').textContent += '\n\n No plottable outputs returned.';
        }

        // Download links
        const dl = [];
        if (js.csv) {
          dl.push(`<a href="/api/download?path=${encodeURIComponent(js.csv)}">Download CSV</a>`);
        }
        if (dl.length > 0) {
          $('downloads').innerHTML = '<strong>Downloads:</strong> ' + dl.join(' | ');
        }
      } catch (e) {
        $('logs').textContent = 'Network error: ' + e.message;
        alert('Network error occurred. Check logs.');
      }
    };
  </script>
</body>
</html>