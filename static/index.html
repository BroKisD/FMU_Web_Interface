<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FMU Web Runner</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&family=Space+Grotesk:wght@500;600&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body { 
      font-family: "Space Grotesk", "IBM Plex Sans", "Segoe UI", sans-serif; 
      margin: 0; 
      background: radial-gradient(1200px 600px at 10% -10%, #f2f8ff 0%, #f8fbf7 50%, #f7f7ff 100%);
      color: #1f2933; 
      line-height: 1.5;
    }
    header { 
      background: linear-gradient(120deg, #0b1220 0%, #142038 65%, #17273f 100%);
      color: #f8fafc; 
      padding: 28px 24px; 
      box-shadow: 0 6px 24px rgba(8, 15, 30, 0.25);
    }
    h1 { margin: 0; font-size: 26px; font-weight: 600; letter-spacing: 0.4px; }
    .header-subtitle {
      margin-top: 6px;
      font-size: 13px;
      color: rgba(248, 250, 252, 0.78);
    }
    .header-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }
    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(248, 250, 252, 0.3);
      font-size: 11px;
      letter-spacing: 0.2px;
      text-transform: uppercase;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 18px; }
    .card { 
      background: rgba(255, 255, 255, 0.9); 
      margin: 18px 0; 
      padding: 22px; 
      border-radius: 16px; 
      box-shadow: 0 10px 26px rgba(18, 28, 45, 0.08);
      border: 1px solid rgba(148, 163, 184, 0.25);
      backdrop-filter: blur(6px);
      animation: floatIn 0.7s ease both;
    }
    .card:nth-of-type(1) { animation-delay: 0.05s; }
    .card:nth-of-type(2) { animation-delay: 0.12s; }
    .card:nth-of-type(3) { animation-delay: 0.19s; }
    .card h2 { 
      margin: 0 0 18px 0; 
      font-size: 18px; 
      font-weight: 600; 
      color: #0f172a;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .card h2::before {
      content: '';
      display: inline-block;
      width: 14px;
      height: 14px;
      background: linear-gradient(135deg, #f97316 0%, #facc15 100%);
      border-radius: 4px;
      box-shadow: 0 0 0 6px rgba(249, 115, 22, 0.12);
    }
    
    .upload-area {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    
    input[type="file"] {
      padding: 10px 14px;
      border: 1.5px dashed #cbd5e1;
      border-radius: 10px;
      background: #f8fafc;
      cursor: pointer;
      flex: 1;
      min-width: 220px;
      font-size: 13px;
    }
    input[type="file"]:hover {
      border-color: #fb923c;
      background: #fff7ed;
    }
    
    button { 
      background: linear-gradient(135deg, #f97316 0%, #f59e0b 100%);
      border: none; 
      color: #fff; 
      padding: 10px 20px; 
      border-radius: 10px; 
      cursor: pointer; 
      font-weight: 600;
      font-size: 13px;
      letter-spacing: 0.2px;
      transition: all 0.2s;
      box-shadow: 0 8px 16px rgba(249, 115, 22, 0.25);
    }
    button:hover { 
      transform: translateY(-1px);
      box-shadow: 0 12px 22px rgba(249, 115, 22, 0.3);
    }
    button:active {
      transform: translateY(0);
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 14px;
      margin-bottom: 18px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .form-group label {
      font-size: 12px;
      font-weight: 600;
      color: #475569;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
    
    .form-group input,
    .form-group select {
      padding: 10px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
      background: #fff;
      transition: all 0.2s;
      box-shadow: inset 0 1px 2px rgba(15, 23, 42, 0.04);
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #f97316;
      box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.15);
    }
    
    .form-group textarea {
      padding: 10px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 13px;
      font-family: ui-monospace, Menlo, Consolas, monospace;
      background: #f7fafc;
      min-height: 100px;
      resize: vertical;
    }
    
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      background: #fff7ed;
      border-radius: 10px;
      border: 1px solid rgba(249, 115, 22, 0.2);
    }
    
    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    
    .checkbox-group label {
      margin: 0;
      cursor: pointer;
      user-select: none;
    }
    
    .section-title {
      font-size: 14px;
      font-weight: 600;
      color: #0f172a;
      margin: 18px 0 10px 0;
      padding-bottom: 8px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .actions {
      display: flex;
      gap: 10px;
      margin-top: 18px;
      flex-wrap: wrap;
    }
    
    .btn-secondary {
      background: #1f2933;
      box-shadow: 0 6px 14px rgba(30, 41, 59, 0.2);
    }
    
    .btn-secondary:hover {
      box-shadow: 0 4px 8px rgba(113, 128, 150, 0.4);
    }
    
    pre { 
      background: #f8fafc; 
      padding: 16px; 
      border-radius: 12px; 
      overflow: auto; 
      font-size: 13px;
      border: 1px solid #e2e8f0;
      margin: 0;
    }
    
    details {
      margin-top: 14px;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 12px;
      background: #f8fafc;
    }
    
    details summary {
      cursor: pointer;
      font-weight: 500;
      color: #4a5568;
      user-select: none;
      padding: 4px;
    }
    
    details[open] summary {
      margin-bottom: 12px;
      padding-bottom: 12px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .chart-container {
      width: 100%;
      margin-bottom: 24px;
      padding: 14px;
      background: #fff;
      border-radius: 14px;
      border: 1px solid #e2e8f0;
    }
    
    .chart-container:last-child {
      margin-bottom: 0;
    }
    
    .chart {
      width: 100%;
      height: 400px;
    }
    
    #downloads {
      margin-top: 14px;
      padding: 12px;
      background: #f8fafc;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
    }
    
    #downloads a {
      color: #f97316;
      text-decoration: none;
      font-weight: 500;
      margin-right: 16px;
    }
    
    #downloads a:hover {
      text-decoration: underline;
    }
    
    .status-message {
      padding: 12px 16px;
      border-radius: 8px;
      margin-top: 12px;
      font-size: 14px;
    }
    
    .status-success {
      background: #dcfce7;
      color: #166534;
      border: 1px solid #86efac;
    }
    
    .status-error {
      background: #fee2e2;
      color: #991b1b;
      border: 1px solid #fca5a5;
    }
    
    .array-input {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .array-item {
      padding: 8px;
      background: #edf2f7;
      border-radius: 4px;
      font-family: ui-monospace, Menlo, Consolas, monospace;
      font-size: 12px;
    }

    .helper {
      font-size: 12px;
      color: #718096;
    }

    .inline-input {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .inline-input input[type="text"] {
      flex: 1;
      min-width: 200px;
    }

    .btn-small {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
    }

    .input-card {
      border: 1px solid #e2e8f0;
      border-radius: 10px;
      padding: 16px;
      background: #f7fafc;
      margin-bottom: 12px;
    }

    .input-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .input-name {
      font-weight: 600;
      color: #1a202c;
      font-size: 14px;
    }

    .input-meta {
      font-size: 12px;
      color: #718096;
    }

    .input-table {
      display: grid;
      gap: 8px;
    }

    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 8px;
      align-items: center;
    }

    .input-row.header {
      font-size: 12px;
      color: #4a5568;
      font-weight: 600;
    }

    .input-row input {
      padding: 8px 10px;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      font-size: 13px;
      background: #fff;
    }

    .vars-section {
      display: grid;
      gap: 16px;
    }

    .vars-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    .vars-table th,
    .vars-table td {
      border: 1px solid #e2e8f0;
      padding: 8px;
      text-align: left;
      vertical-align: top;
    }

    .vars-table th {
      background: #edf2f7;
      font-weight: 600;
      color: #2d3748;
    }

    .info-grid {
      display: grid;
      grid-template-columns: max-content 1fr;
      gap: 8px 16px;
      font-size: 13px;
    }

    .info-label {
      font-weight: 600;
      color: #2d3748;
    }

    @keyframes floatIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
</head>
<body>
  <header>
    <div class="container">
      <h1>FMU Runner</h1>
      <div class="header-subtitle">Upload, tune, and run FMUs without the command line.</div>
      <div class="header-badges">
        <span class="badge">Fast setup</span>
        <span class="badge">Live plots</span>
        <span class="badge">CSV export</span>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="card">
      <h2>Upload FMU</h2>
      <div class="upload-area">
        <input id="fmuFile" type="file" accept=".fmu"/>
        <button id="btnUpload">Upload FMU</button>
      </div>
      <div id="uploadStatus"></div>
    </div>

    <div class="card">
      <h2>Configuration</h2>
      
      <div class="form-grid">
        <div class="form-group">
          <label>Start Time</label>
          <input type="number" id="start_time" step="any" value="0.0">
        </div>
        
        <div class="form-group">
          <label>Stop Time</label>
          <input type="number" id="stop_time" step="any" value="600.0">
        </div>

        <div class="form-group">
          <label>Output Interval</label>
          <input type="number" id="output_interval" step="any" value="0.01">
        </div>

        <div class="form-group">
          <label>Step Size</label>
          <input type="number" id="step_size" step="any" value="0.01">
        </div>
        
        <div class="form-group">
          <label>Solver</label>
          <select id="solver">
            <option value="CVode">CVode</option>
            <option value="Euler">Euler</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Relative Tolerance</label>
          <input type="number" id="relative_tolerance" step="any" value="0.00001">
        </div>
        
        <div class="form-group">
          <label>Timeout (seconds)</label>
          <input type="number" id="timeout" value="60">
        </div>
      </div>

      <div class="form-group">
        <label>Input File (CSV)</label>
        <div class="inline-input">
          <input type="text" id="input_file" placeholder="Upload a CSV or leave empty" readonly>
          <input type="file" id="inputFileUpload" accept=".csv">
          <button class="btn-secondary btn-small" id="btnUploadInput">Upload</button>
        </div>
        <div id="inputUploadStatus" class="helper"></div>
      </div>

      <div class="section-title">Options</div>
      <div class="form-grid">
        <div class="checkbox-group">
          <input type="checkbox" id="record_events" checked>
          <label for="record_events">Record Events</label>
        </div>
        
        <div class="checkbox-group">
          <input type="checkbox" id="debug_logging">
          <label for="debug_logging">Debug Logging</label>
        </div>  
      </div>

      <div class="section-title">Parameters</div>
      <div id="parametersContainer" class="form-grid">
        <div class="helper">Upload an FMU to see parameters.</div>
      </div>

      <div class="section-title">Inputs</div>
      <div id="inputsContainer">
        <div class="helper">Upload an FMU to see input signals.</div>
      </div>

      <div class="section-title">Outputs (comma-separated)</div>
      <div class="form-group">
        <input type="text" id="outputs" placeholder="x, v, p" value="x, v, p">
      </div>

      <div class="form-grid" style="margin-top: 20px;">
        <div class="form-group">
          <label>Output CSV File</label>
          <input type="text" id="output_csv" value="result.csv">
        </div>
      </div>

      <div class="actions">
        <button id="btnRun">▶ Run Simulation</button>
        <button class="btn-secondary" id="btnViewJson">View JSON</button>
      </div>

      <details>
        <summary>FMU Variables (from metadata)</summary>
        <div id="varsDump" class="vars-section">Upload an FMU to see variables</div>
      </details>
      
      <details>
        <summary>FMU Info</summary>
        <div id="fmuInfo">Upload an FMU to see info</div>
      </details>
    </div>

    <div class="card">
      <h2>Results</h2>
      <div id="chartsContainer"></div>
      <div id="downloads"></div>
      <details>
        <summary>Simulation Logs</summary>
        <pre id="logs">No logs yet</pre>
      </details>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    // Helper to gather config from form
    function getConfig() {
      const outputs = $('outputs').value.split(',').map(s => s.trim()).filter(Boolean);
      
      const startValues = collectStartValues();
      const inputs = collectInputs();
      const outputInterval = parseFloat($('output_interval').value);
      const inputFile = $('input_file').value.trim();
      
      return {
        fmu: null, // will be set by backend
        start_time: parseFloat($('start_time').value),
        stop_time: parseFloat($('stop_time').value),
        output_interval: Number.isNaN(outputInterval) ? null : outputInterval,
        step_size: parseFloat($('step_size').value),
        solver: $('solver').value,
        relative_tolerance: parseFloat($('relative_tolerance').value),
        record_events: $('record_events').checked,
        fmi_type: null,
        start_values: startValues,
        inputs: inputs,
        outputs: outputs,
        timeout: parseInt($('timeout').value),
        debug_logging: $('debug_logging').checked,
        output_csv: $('output_csv').value,
        input_file: inputFile || null,
      };
    }

    // Helper to populate form from config
    function setConfig(cfg) {
      $('start_time').value = cfg.start_time || 0;
      $('stop_time').value = cfg.stop_time || 600;
      $('output_interval').value = cfg.output_interval ?? 0.01;
      $('step_size').value = cfg.step_size || 0.01;
      $('solver').value = cfg.solver || 'CVode';
      $('relative_tolerance').value = cfg.relative_tolerance || 0.00001;
      $('timeout').value = cfg.timeout || 60;
      $('record_events').checked = cfg.record_events !== false;
      $('debug_logging').checked = cfg.debug_logging || false;
      $('outputs').value = (cfg.outputs || []).join(', ');
      $('output_csv').value = cfg.output_csv || 'result.csv';
      $('input_file').value = cfg.input_file || '';
    }

    function clearNode(node) {
      while (node.firstChild) node.removeChild(node.firstChild);
    }

    function createText(tag, text, className) {
      const el = document.createElement(tag);
      if (className) el.className = className;
      el.textContent = text;
      return el;
    }

    function renderParameters(params, startValues) {
      const container = $('parametersContainer');
      clearNode(container);
      if (!params || params.length === 0) {
        container.appendChild(createText('div', 'No parameters found.', 'helper'));
        return;
      }

      params.forEach(param => {
        const group = document.createElement('div');
        group.className = 'form-group';
        group.dataset.param = 'true';
        group.dataset.name = param.name;
        group.dataset.type = param.type;

        const label = createText('label', param.name);
        group.appendChild(label);

        let input;
        if (param.type === 'Boolean') {
          input = document.createElement('select');
          const optTrue = createText('option', 'true');
          optTrue.value = 'true';
          const optFalse = createText('option', 'false');
          optFalse.value = 'false';
          input.appendChild(optTrue);
          input.appendChild(optFalse);
        } else {
          input = document.createElement('input');
          input.type = param.type === 'String' ? 'text' : 'number';
          if (param.type === 'Integer') input.step = '1';
          if (param.type === 'Real') input.step = 'any';
        }
        input.value = startValues && startValues[param.name] != null ? startValues[param.name] : (param.start ?? '');
        input.className = 'param-input';
        group.appendChild(input);

        if (param.description) {
          group.appendChild(createText('div', param.description, 'helper'));
        }

        container.appendChild(group);
      });
    }

    function addInputRow(table, timeValue, valueValue) {
      const row = document.createElement('div');
      row.className = 'input-row';
      row.dataset.row = 'true';

      const timeInput = document.createElement('input');
      timeInput.type = 'number';
      timeInput.step = 'any';
      timeInput.placeholder = 'time';
      if (timeValue !== undefined && timeValue !== null) timeInput.value = timeValue;

      const valueInput = document.createElement('input');
      valueInput.type = 'number';
      valueInput.step = 'any';
      valueInput.placeholder = 'value';
      if (valueValue !== undefined && valueValue !== null) valueInput.value = valueValue;

      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'btn-secondary btn-small';
      removeBtn.textContent = 'Remove';
      removeBtn.onclick = () => row.remove();

      row.appendChild(timeInput);
      row.appendChild(valueInput);
      row.appendChild(removeBtn);
      table.appendChild(row);
    }

    function renderInputs(inputs, configInputs) {
      const container = $('inputsContainer');
      clearNode(container);
      if (!inputs || inputs.length === 0) {
        container.appendChild(createText('div', 'No input variables found.', 'helper'));
        return;
      }

      const scheduleMap = new Map();
      (configInputs || []).forEach(entry => {
        if (Array.isArray(entry) && entry.length === 2) {
          scheduleMap.set(entry[0], entry[1] || []);
        }
      });

      inputs.forEach(inputVar => {
        const card = document.createElement('div');
        card.className = 'input-card';
        card.dataset.name = inputVar.name;
        card.dataset.type = inputVar.type;

        const header = document.createElement('div');
        header.className = 'input-card-header';

        const titleWrap = document.createElement('div');
        titleWrap.appendChild(createText('div', inputVar.name, 'input-name'));
        const meta = [inputVar.type, inputVar.description].filter(Boolean).join(' • ');
        if (meta) titleWrap.appendChild(createText('div', meta, 'input-meta'));

        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.className = 'btn-secondary btn-small';
        addBtn.textContent = 'Add row';

        header.appendChild(titleWrap);
        header.appendChild(addBtn);
        card.appendChild(header);

        const table = document.createElement('div');
        table.className = 'input-table';
        const headerRow = document.createElement('div');
        headerRow.className = 'input-row header';
        headerRow.innerHTML = '<div>Time</div><div>Value</div><div></div>';
        table.appendChild(headerRow);

        const schedule = scheduleMap.get(inputVar.name) || [];
        if (schedule.length > 0) {
          schedule.forEach(pair => {
            addInputRow(table, pair[0], pair[1]);
          });
        } else if (inputVar.start != null) {
          addInputRow(table, 0.0, inputVar.start);
        } else {
          addInputRow(table);
        }

        addBtn.onclick = () => addInputRow(table);

        card.appendChild(table);
        container.appendChild(card);
      });
    }

    function collectStartValues() {
      const values = {};
      document.querySelectorAll('#parametersContainer [data-param="true"]').forEach(group => {
        const name = group.dataset.name;
        const type = group.dataset.type;
        const input = group.querySelector('.param-input');
        if (!input) return;
        const raw = input.value;
        if (raw === '') return;
        if (type === 'Boolean') {
          values[name] = raw === 'true';
        } else if (type === 'Integer') {
          const v = parseInt(raw, 10);
          if (!Number.isNaN(v)) values[name] = v;
        } else if (type === 'Real') {
          const v = parseFloat(raw);
          if (!Number.isNaN(v)) values[name] = v;
        } else {
          values[name] = raw;
        }
      });
      return values;
    }

    function collectInputs() {
      const inputs = [];
      document.querySelectorAll('#inputsContainer .input-card').forEach(card => {
        const name = card.dataset.name;
        const rows = [];
        card.querySelectorAll('.input-row[data-row="true"]').forEach(row => {
          const fields = row.querySelectorAll('input');
          if (fields.length < 2) return;
          const t = parseFloat(fields[0].value);
          const v = parseFloat(fields[1].value);
          if (!Number.isNaN(t) && !Number.isNaN(v)) {
            rows.push([t, v]);
          }
        });
        if (rows.length > 0) {
          inputs.push([name, rows]);
        }
      });
      return inputs;
    }

    $('btnUpload').onclick = async () => {
      const file = $('fmuFile').files[0];
      if (!file) {
        $('uploadStatus').innerHTML = '<div class="status-message status-error">Please select a .fmu file first.</div>';
        return;
      }
      
      const fd = new FormData();
      fd.append('file', file);
      $('uploadStatus').innerHTML = '<div class="status-message">Uploading...</div>';
      
      try {
        const res = await fetch('/api/upload-fmu', { method: 'POST', body: fd });
        const js = await res.json();
        
        if (!js.ok) {
          $('uploadStatus').innerHTML = '<div class="status-message status-error">Upload failed: ' + (js.error || 'unknown') + '</div>';
          return;
        }
        
        $('uploadStatus').innerHTML = '<div class="status-message status-success">✓ Uploaded successfully<br>Host platform: ' + js.template.platform + '</div>';
        
        // Populate form with template config
        if (js.template.config) {
          setConfig(js.template.config);
        }

        renderParameters(js.template.variables.parameters, js.template.config?.start_values || {});
        renderInputs(js.template.variables.inputs, js.template.config?.inputs || []);

        renderVariables(js.template.variables);
        renderInfo(js.template.info);
      } catch (e) {
        $('uploadStatus').innerHTML = '<div class="status-message status-error">Error: ' + e.message + '</div>';
      }
    };

    $('btnUploadInput').onclick = async () => {
      const file = $('inputFileUpload').files[0];
      if (!file) {
        $('inputUploadStatus').textContent = 'Select a CSV file to upload.';
        return;
      }

      const fd = new FormData();
      fd.append('file', file);
      $('inputUploadStatus').textContent = 'Uploading input file...';

      try {
        const res = await fetch('/api/upload-input', { method: 'POST', body: fd });
        const js = await res.json();
        if (!js.ok) {
          $('inputUploadStatus').textContent = 'Upload failed: ' + (js.error || 'unknown');
          return;
        }
        $('input_file').value = js.path;
        $('inputUploadStatus').textContent = 'Input file uploaded.';
      } catch (e) {
        $('inputUploadStatus').textContent = 'Upload error: ' + e.message;
      }
    };

    $('btnViewJson').onclick = () => {
      try {
        const cfg = getConfig();
        alert(JSON.stringify(cfg, null, 2));
      } catch (e) {
        // Error already shown by getConfig
      }
    };

    $('btnRun').onclick = async () => {
      let cfg;
      try {
        cfg = getConfig();
      } catch (e) {
        return; // Error already shown
      }

      $('logs').textContent = 'Running simulation...';
      $('downloads').innerHTML = '';
      $('chartsContainer').innerHTML = '';

      try {
        const res = await fetch('/api/run', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(cfg)
        });
        const js = await res.json();

        if (!js.ok) {
          $('logs').textContent = (js.logs || []).join('\n') + '\n\n ERROR: ' + js.error + '\n' + (js.trace || '');
          alert('Simulation failed. Check logs below.');
          return;
        }

        // Show logs
        $('logs').textContent = (js.logs || []).join('\n') + '\n\n Simulation completed successfully';

        // Plot results - separate graph for each output
        const cols = js.columns || [];
        const rows = js.rows || [];
        const time = rows.map(r => r.time !== undefined ? r.time : r[cols[0]]);
        const outputs = cols.filter(c => c !== 'time');

        if (outputs.length > 0) {
          const chartsContainer = $('chartsContainer');
          
          // Color palette for different graphs
          const colors = [
            '#f97316', // Orange
            '#0ea5e9', // Sky
            '#22c55e', // Green
            '#f43f5e', // Rose
            '#eab308', // Amber
            '#14b8a6', // Teal
            '#f59e0b', // Gold
            '#10b981', // Emerald
            '#38bdf8', // Light blue
            '#fb7185'  // Pink
          ];
          
          // Create a separate graph for each output
          outputs.forEach((outputName, idx) => {
            // Create container div for this chart
            const chartWrapper = document.createElement('div');
            chartWrapper.className = 'chart-container';
            
            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart';
            chartDiv.id = `chart_${idx}`;
            
            chartWrapper.appendChild(chartDiv);
            chartsContainer.appendChild(chartWrapper);
            
            // Create trace for this output with unique color
            const trace = {
              x: time,
              y: rows.map(r => r[outputName]),
              mode: 'lines',
              name: outputName,
              line: { width: 2, color: colors[idx % colors.length] }
            };
            
            // Create layout for this chart
            const layout = {
              title: { 
                text: outputName, 
                font: { size: 16, weight: 600 } 
              },
              xaxis: { 
                title: 'Time [s]', 
                gridcolor: '#e2e8f0' 
              },
              yaxis: { 
                title: outputName, 
                gridcolor: '#e2e8f0' 
              },
              paper_bgcolor: '#ffffff',
              plot_bgcolor: '#f7fafc',
              margin: { t: 50, b: 60, l: 60, r: 40 }
            };
            
            // Plot this chart
            Plotly.newPlot(`chart_${idx}`, [trace], layout, {responsive: true});
          });
        } else {
          $('logs').textContent += '\n\n No plottable outputs returned.';
        }

        // Download links
        const dl = [];
        if (js.csv) {
          dl.push(`<a href="/api/download?path=${encodeURIComponent(js.csv)}">Download CSV</a>`);
        }
        if (dl.length > 0) {
          $('downloads').innerHTML = '<strong>Downloads:</strong> ' + dl.join(' | ');
        }
      } catch (e) {
        $('logs').textContent = 'Network error: ' + e.message;
        alert('Network error occurred. Check logs.');
      }
    };

    function renderVariables(groups) {
      const container = $('varsDump');
      clearNode(container);
      if (!groups) {
        container.textContent = 'No variables available.';
        return;
      }

      const sections = [
        ['Parameters', groups.parameters],
        ['Inputs', groups.inputs],
        ['Outputs', groups.outputs],
        ['Independent', groups.independent],
      ];

      sections.forEach(([title, list]) => {
        const section = document.createElement('div');
        section.appendChild(createText('div', title, 'section-title'));
        if (!list || list.length === 0) {
          section.appendChild(createText('div', 'None', 'helper'));
        } else {
          const table = document.createElement('table');
          table.className = 'vars-table';
          const thead = document.createElement('thead');
          const headRow = document.createElement('tr');
          ['Name', 'Type', 'Start', 'Variability', 'Description'].forEach(label => {
            const th = document.createElement('th');
            th.textContent = label;
            headRow.appendChild(th);
          });
          thead.appendChild(headRow);
          table.appendChild(thead);
          const tbody = document.createElement('tbody');
          list.forEach(v => {
            const row = document.createElement('tr');
            const cells = [
              v.name,
              v.type,
              v.start != null ? v.start : '',
              v.variability || '',
              v.description || ''
            ];
            cells.forEach(value => {
              const td = document.createElement('td');
              td.textContent = value;
              row.appendChild(td);
            });
            tbody.appendChild(row);
          });
          table.appendChild(tbody);
          section.appendChild(table);
        }
        container.appendChild(section);
      });
    }

    function renderInfo(info) {
      const container = $('fmuInfo');
      clearNode(container);
      if (!info) {
        container.textContent = 'No info available.';
        return;
      }

      const grid = document.createElement('div');
      grid.className = 'info-grid';
      Object.entries(info).forEach(([key, value]) => {
        grid.appendChild(createText('div', key, 'info-label'));
        grid.appendChild(createText('div', String(value)));
      });
      container.appendChild(grid);
    }
  </script>
</body>
</html>
